# dev.mk - Local development targets
# Generated by cli_core bootstrap

# Auto-detect system architecture and update .env file
detect-arch:
	@ARCH=$$(uname -m | sed 's/x86_64/amd64/; s/aarch64/arm64/') && \
	echo "Detected architecture: $$ARCH" && \
	if [ -f "$(GIT_ROOT)/misc/dockerfiles/.env" ]; then \
		sed -i.bak "s/DOCKER_ARCH=.*/DOCKER_ARCH=$$ARCH/" $(GIT_ROOT)/misc/dockerfiles/.env && \
		rm -f $(GIT_ROOT)/misc/dockerfiles/.env.bak && \
		echo "Updated .env file with DOCKER_ARCH=$$ARCH"; \
	fi

compose-up: detect-arch
	@echo "Starting containers..." && \
	docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml up -d --build --force-recreate

compose-down:
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml down

compose-down-full:
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml down -v

compose-stop:
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml stop

compose-logs:
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml logs -f

{{- if .Features.kafka }}

redpanda-up: detect-arch
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml up -d redpanda

redpanda-init:
	@echo "Initializing Redpanda topics..."
	@docker exec redpanda bash -c "rpk topic create local-events --partitions 1 --replicas 1 || echo 'Topic already exists'"
	@echo "Redpanda initialization complete"
{{- end }}

local-deps-up: detect-arch
{{- if .Features.kafka }}
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml up -d redpanda postgres redis
{{- else }}
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml up -d postgres redis
{{- end }}

start-local: detect-arch
	@$(MAKE) VERSION=unversioned build-linux
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml up -d --build --force-recreate

start-ms-single: detect-arch
	@$(MAKE) build-single/$(MS)
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml up -d --build $(MS) --force-recreate

stop-ms:
	@docker-compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml stop

logs-ms-single:
	@docker compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml logs $(MS) -f

logs-ms:
	@docker compose -f $(GIT_ROOT)/misc/dockerfiles/docker-compose.yaml logs -f

get-ms-names:
	@echo $(MS_NAMES_K8S)

get-cli-names:
	@echo $(CLI_NAMES_K8S)

fix-imports:
	@echo "Fixing import grouping..."
	@find . -type f -name '*.go' -not -path './vendor/*' -not -path './.git/*' -print0 | xargs -0 goimports -w -local "$(LOCAL_MODULE)"
	@echo "Import grouping fixed."

check-imports:
	@echo "Checking import grouping..."
	@for f in $$(find . -type f -name '*.go' -not -path './vendor/*'); do \
		diff=$$(goimports -d -local "$(LOCAL_MODULE)" $$f); \
		if [ -n "$$diff" ]; then \
			printf "Imports misordered in %s\n%s\n" "$$f" "$$diff"; \
			exit 1; \
		fi; \
	done;
	@echo "All imports are correctly grouped."

ide-run-configs:
	@echo "Generating JetBrains run configurations..."
	@if [ -f "misc/scripts/generate_run_configs.go" ]; then \
		cd misc/scripts && go run generate_run_configs.go; \
		echo "Run configurations generated successfully."; \
	else \
		echo "No run config generator found."; \
	fi

# Run a specific microservice locally
run-ms:
	@if [ -z "$(MS)" ]; then \
		echo "Usage: make run-ms MS=<microservice_name>"; \
		exit 1; \
	fi
	@bash -c "set -a && source misc/envs/ms_$(MS).local.env 2>/dev/null; set +a && CONFIG_FILES=misc/configs/ms_$(MS).json go run cmd/ms/ms_$(MS)/application.go"
