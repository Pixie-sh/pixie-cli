# common.mk - Common variables and settings
# Generated by cli_core bootstrap

GOARCH ?= $(shell go env GOARCH)
GOOS ?= $(shell go env GOOS)
GOSUMDB ?= sum.golang.org
GONOSUMDB ?=
GONOPROXY ?=
GOPRIVATE ?=

VERBOSE ?= false
ARGS = $(wordlist 2, $(words $(MAKECMDGOALS)), $(MAKECMDGOALS))
LOCAL_MODULE := $(shell awk '/^module / { print $$2; exit }' go.mod)

MAIN_PACKAGES ?= $(shell go list -f '{{ "{{" }} .ImportPath {{ "}}" }}:{{ "{{" }} .Name {{ "}}" }}' ./cmd/... | grep ":main" | grep -v "/examples/" | cut -d: -f1)

MS_MAIN_PACKAGES ?= $(shell go list -f '{{ "{{" }} .ImportPath {{ "}}" }}:{{ "{{" }} .Name {{ "}}" }}' ./cmd/... | grep ":main" | grep -v "/examples/" | cut -d: -f1 | grep "/ms/")
MS_NAMES ?= $(shell echo $(MAIN_PACKAGES) | tr ' ' '\n' | grep '/cmd/ms/' | sed 's|{{ .ModuleName }}/cmd/ms/||')
MS_NAMES_K8S ?= $(shell echo $(MS_NAMES) | tr '_' '-')

CLI_MAIN_PACKAGES ?= $(shell go list -f '{{ "{{" }} .ImportPath {{ "}}" }}:{{ "{{" }} .Name {{ "}}" }}' ./cmd/... | grep ":main" | grep -v "/examples/" | cut -d: -f1 | grep "/cli/")
CLI_NAMES ?= $(shell echo $(MAIN_PACKAGES) | tr ' ' '\n' | grep '/cmd/cli/' | sed 's|{{ .ModuleName }}/cmd/cli/||')
CLI_NAMES_K8S ?= $(shell echo $(CLI_NAMES) | tr '_' '-')

# Default output directory
GIT_ROOT ?= $(shell git rev-parse --show-toplevel)
BASE_OUT_DIR ?= $(GIT_ROOT)/bin
AMD64_OUT_DIR = bin_amd64
ARM64_OUT_DIR = bin_arm64
OUT_DIR_AMD ?= $(GIT_ROOT)/$(AMD64_OUT_DIR)
OUT_DIR_ARM ?= $(GIT_ROOT)/$(ARM64_OUT_DIR)
OUT_DIR_GOARCH ?= $(GIT_ROOT)/bin_$(GOARCH)

MAKE = $(shell which make)
SCOPE ?= "local"

# Versioning information
VERSION ?= $(shell git describe --tags --abbrev=0 2> /dev/null || echo "unversioned")
CI_COMMIT_REF_NAME ?= $(shell git rev-parse --short HEAD || echo "unversioned")
VERSION_PACKAGE ?= {{ .ModuleName }}/infra/version
LDFLAGS = "-X '$(VERSION_PACKAGE).Version=$(VERSION)' -X '$(VERSION_PACKAGE).Commit=$(CI_COMMIT_REF_NAME)' -s -w"
