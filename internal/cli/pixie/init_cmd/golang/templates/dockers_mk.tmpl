# dockers.mk - Docker build and push targets
# Generated by cli_pixie bootstrap

# ECR Registry - update this with your registry URL
ECR_REGISTRY ?= your-account.dkr.ecr.region.amazonaws.com

push-ms-dockers: output-env
	@echo "=== building and pushing docker images for ms ==="
	@echo "=== ms to upload to ECR: $(MS_NAMES) ==="
	@bash -c '\
		ms_names=($(MS_NAMES)); \
		ms_names_k8s=($(MS_NAMES_K8S)); \
		for i in "$${!ms_names[@]}"; do \
			ms="$${ms_names[$$i]}"; \
			ms_k8s="$${ms_names_k8s[$$i]}"; \
			execPath="./$(ARM64_OUT_DIR)/$(VERSION)_$$ms"; \
			wsHealthPath="./$(ARM64_OUT_DIR)/$(VERSION)_health.sh" ;\
			echo "Building ARM $$ms_k8s:$(VERSION)"; \
			docker build --platform linux/arm64 --build-arg EXEC_PATH=$$execPath --build-arg EXEC_CONFIG=$$execPath.json --build-arg WS_HEALTH_SCRIPT=$$wsHealthPath -t $(ECR_REGISTRY)/{{ .ProjectName }}-$$ms_k8s:$(VERSION) -f $(GIT_ROOT)/misc/dockerfiles/Dockerfile . --push; \
			execPath="./$(AMD64_OUT_DIR)/$(VERSION)_$$ms"; \
			wsHealthPath="./$(AMD64_OUT_DIR)/$(VERSION)_health.sh" ;\
			echo "Building AMD $$ms_k8s:$(VERSION)"; \
			docker build --platform linux/amd64 --build-arg EXEC_PATH=$$execPath --build-arg EXEC_CONFIG=$$execPath.json --build-arg WS_HEALTH_SCRIPT=$$wsHealthPath -t $(ECR_REGISTRY)/{{ .ProjectName }}-$$ms_k8s:$(VERSION) -f $(GIT_ROOT)/misc/dockerfiles/Dockerfile . --push; \
		done'

build-ms-dockers: output-env
	@echo "=== building docker images for ms ==="
	@echo "=== ms to build to ECR: $(MS_NAMES) ==="
	@bash -c '\
		ms_names=($(MS_NAMES)); \
		ms_names_k8s=($(MS_NAMES_K8S)); \
		for i in "$${!ms_names[@]}"; do \
			ms="$${ms_names[$$i]}"; \
			ms_k8s="$${ms_names_k8s[$$i]}"; \
			execPath="./$(ARM64_OUT_DIR)/$(VERSION)_$$ms"; \
			wsHealthPath="./$(ARM64_OUT_DIR)/$(VERSION)_health.sh" ;\
			echo "Building ARM $$ms_k8s:$(VERSION)"; \
			docker build --platform linux/arm64 --build-arg EXEC_PATH=$$execPath --build-arg EXEC_CONFIG=$$execPath.json --build-arg WS_HEALTH_SCRIPT=$$wsHealthPath -t $$ms_k8s:$(VERSION) -f $(GIT_ROOT)/misc/dockerfiles/Dockerfile .; \
			execPath="./$(AMD64_OUT_DIR)/$(VERSION)_$$ms"; \
			wsHealthPath="./$(AMD64_OUT_DIR)/$(VERSION)_health.sh" ;\
			echo "Building AMD $$ms_k8s:$(VERSION)"; \
			docker build --platform linux/amd64 --build-arg EXEC_PATH=$$execPath --build-arg EXEC_CONFIG=$$execPath.json --build-arg WS_HEALTH_SCRIPT=$$wsHealthPath -t $$ms_k8s:$(VERSION) -f $(GIT_ROOT)/misc/dockerfiles/Dockerfile .; \
		done'
