# Makefile - Main entry point
# Generated by cli_pixie bootstrap for {{ .ProjectName }}

include common.mk
include dockers.mk
include dev.mk

# Update phony targets
.PHONY: tests build build-linux build-mac build-amd64 build-arm64 \
        build-linux-amd64 build-linux-arm64 build-mac-amd64 build-mac-arm64 \
        fast-build-linux fast-build-mac ensure-deps fix-deps post-build \
        clean clean-bin deep-clean check-dependencies output-env git-config \
        test test-coverage tidy lint fmt

# Run all tests
tests:
ifdef GITHUB_ACTIONS
	@rm $(GIT_ROOT)/go.sum || echo 'no go.sum found'
	@go mod tidy
endif
	@go test ./... -v -cover

test: tests

# Run tests with coverage
test-coverage:
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html

# Build for current OS/Arch
build:
	@$(MAKE) build-linux

build-linux: check-dependencies output-env git-config ensure-deps
	mkdir -p $(OUT_DIR_AMD)
	mkdir -p $(OUT_DIR_ARM)
	@echo "=== Building application for production ==="
	@$(MAKE) -j2 build-linux-amd64 build-linux-arm64
	@VERSION=$(VERSION) $(MAKE) post-build

# Fast parallel architecture builds
build-linux-amd64:
	@echo "=== Building AMD64 for Linux ==="
	@GOOS=linux $(MAKE) build-amd64

build-linux-arm64:
	@echo "=== Building ARM64 for Linux ==="
	@GOOS=linux $(MAKE) build-arm64

# Fast parallel architecture builds for macOS
build-mac: check-dependencies output-env git-config ensure-deps
	mkdir -p $(OUT_DIR_AMD)
	mkdir -p $(OUT_DIR_ARM)
	@echo "=== Building application for production ==="
	@$(MAKE) -j2 build-mac-amd64 build-mac-arm64
	@VERSION=$(VERSION) $(MAKE) post-build

build-mac-amd64:
	@echo "=== Building AMD64 for macOS ==="
	@GOOS=darwin $(MAKE) build-amd64

build-mac-arm64:
	@echo "=== Building ARM64 for macOS ==="
	@GOOS=darwin $(MAKE) build-arm64

# Ensure dependencies are downloaded and cached
ensure-deps:
	@echo "=== Ensuring Deps ==="
	@GOSUMDB=$(GOSUMDB) go version
	@GOSUMDB=$(GOSUMDB) go mod tidy
	@GOSUMDB=$(GOSUMDB) go get ./...
	@GOSUMDB=$(GOSUMDB) go mod tidy

build-amd64: check
	GOOS=$(GOOS) GOARCH=amd64 CGO_ENABLED=0 go build -mod=readonly -ldflags=$(LDFLAGS) -o $(OUT_DIR_AMD)/ $(MS_MAIN_PACKAGES)
	GOOS=$(GOOS) GOARCH=amd64 CGO_ENABLED=0 go build -mod=readonly -ldflags=$(LDFLAGS) -o $(OUT_DIR_AMD)/ $(CLI_MAIN_PACKAGES)

build-arm64: check
	GOOS=$(GOOS) GOARCH=arm64 CGO_ENABLED=0 go build -mod=readonly -ldflags=$(LDFLAGS) -o $(OUT_DIR_ARM)/ $(MS_MAIN_PACKAGES)
	GOOS=$(GOOS) GOARCH=arm64 CGO_ENABLED=0 go build -mod=readonly -ldflags=$(LDFLAGS) -o $(OUT_DIR_ARM)/ $(CLI_MAIN_PACKAGES)

post-build:
	@echo "=== Post build ==="
	@$(MAKE) rename-executables
	@$(MAKE) copy-ms-configs
	@$(MAKE) copy-cli-configs

rename-executables:
	@echo "Renaming executables with Git version $(VERSION)..."
	@for exe in ./$(AMD64_OUT_DIR)/* ; do \
		if [ -f "$$exe" ]; then \
			mv "$$exe" "$${exe%/*}/$(VERSION)_$${exe##*/}" ; \
		fi \
	done
	@for exe in ./$(ARM64_OUT_DIR)/* ; do \
		if [ -f "$$exe" ]; then \
			mv "$$exe" "$${exe%/*}/$(VERSION)_$${exe##*/}" ; \
		fi \
	done

build-single/%: check-dependencies output-env
	@echo "=== Building <$*> for $(GOOS) ==="
	@GOOS=$(GOOS) GOARCH=$(GOARCH) go build -ldflags=$(LDFLAGS) -o $(BASE_OUT_DIR)_$(GOARCH)/unversioned_$* $(shell echo $(MAIN_PACKAGES) | tr " " "\n" | grep $*$$)
	@chmod +x $(BASE_OUT_DIR)_$(GOARCH)/unversioned_$*
	@cp misc/configs/$*.json $(BASE_OUT_DIR)_$(GOARCH)/unversioned_$*.json

output-env:
ifeq ($(VERBOSE), true)
	@echo "=== output make vars ===" ;\
	echo "MAIN_PACKAGES: "${MAIN_PACKAGES} ;\
	echo "MS_MAIN_PACKAGES: "${MS_MAIN_PACKAGES} ;\
	echo "CLI_MAIN_PACKAGES: "${CLI_MAIN_PACKAGES} ;\
	echo "MS_NAMES: "${MS_NAMES} ;\
	echo "MS_NAMES_K8S: "${MS_NAMES_K8S} ;\
	echo "CLI_NAMES: "${CLI_NAMES} ;\
	echo "CLI_NAMES_K8S: "${CLI_NAMES_K8S} ;\
	echo "ENV: "${ENV} ;\
	echo "VERSION: "${VERSION} ;\
	echo "CI_COMMIT_REF_NAME: "${CI_COMMIT_REF_NAME} ;\
	echo "VERSION_PACKAGE: "${VERSION_PACKAGE} ;\
	echo "LDFLAGS: "${LDFLAGS}
endif

git-config:
	go env -w GOPRIVATE="github.com"
ifndef CI
	git config --global url."git@github.com:".insteadOf "https://github.com/"
else
	@echo "Skipping SSH config in CI environment"
endif

copy-ms-configs:
	@echo "=== Copying configs for ms packages ==="
	@echo "=== ms to process: $(MS_NAMES) ==="
	@for ms in $(MS_NAMES); do \
		config_path="$(GIT_ROOT)/misc/configs/$$ms.json" ;\
		if [ -f $$config_path ]; then \
			echo "Processing $$config_path..." ;\
			cp $$config_path $(OUT_DIR_AMD)/$(VERSION)_$$ms.json ;\
			cp $$config_path $(OUT_DIR_ARM)/$(VERSION)_$$ms.json ;\
		else \
			echo "File $$config_path does not exist." ;\
		fi \
	done

copy-cli-configs:
	@echo "=== Copying configs for cli packages ==="
	@echo "=== cli to process: $(CLI_NAMES) ==="
	@for ms in $(CLI_NAMES); do \
		config_path="$(GIT_ROOT)/misc/configs/$$ms.json" ;\
		if [ -f $$config_path ]; then \
			echo "Processing $$config_path..." ;\
			cp $$config_path $(OUT_DIR_AMD)/$(VERSION)_$$ms.json ;\
			cp $$config_path $(OUT_DIR_ARM)/$(VERSION)_$$ms.json ;\
		else \
			echo "File $$config_path does not exist." ;\
		fi \
	done

check-dependencies:
	@MISSING=""; \
	check() { \
		which $$1 >/dev/null || MISSING="$$MISSING $$1"; \
	}; \
	check git; \
	check go; \
	if [ -n "$$MISSING" ]; then \
		echo "Missing dependencies:$$MISSING"; \
		exit 1; \
	fi; \
	echo "All dependencies are installed.";

check:
	@echo "Running checks..."
	@go vet ./...

clean-bin:
	@echo "Cleaning binaries..."
	rm -rf $(OUT_DIR_AMD)
	rm -rf $(OUT_DIR_ARM)
	rm -rf bin/

# Light clean - just remove binaries (preserves dependency cache)
clean: clean-bin
	rm -f coverage.out coverage.html
	@echo "=== Light clean completed ==="

# Deep clean - full dependency reset (use when you have dependency issues)
deep-clean: clean-bin
	@echo "=== Deep cleaning golang dependencies ==="
	@go env -w GOPROXY=https://proxy.golang.org,direct
	@rm -f $(GIT_ROOT)/go.sum
	@go clean -modcache
	@go mod download
	@go mod tidy
	@echo "=== Deep clean completed ==="

# Tidy dependencies
tidy:
	go mod tidy

# Lint the code
lint:
	golangci-lint run

# Format code
fmt:
	go fmt ./...

%: # Prevent errors for unknown targets
	@true
